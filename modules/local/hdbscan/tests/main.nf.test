nextflow_process {

    name "Test HDBSCAN"
    script "../main.nf"
    process "HDBSCAN"

    tag "modules"
    tag "modules_local"
    tag "hdbscan"

    test("Should cluster UMAP coordinates with HDBSCAN") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test', single_end:true ],
                    file(params.test_data['nanopore']['analysis']['umap_coords'], checkIfExists: true)
                ]
                input[1] = 5           // min_cluster_size (realistic for 50 reads)
                input[2] = 3           // min_samples
                input[3] = 0.0         // cluster_selection_epsilon
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("Should produce cluster assignments, info, and plot") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_output', single_end:true ],
                    file(params.test_data.nanopore.analysis.umap_coords, checkIfExists: true)
                ]
                input[1] = 5           // min_cluster_size (same as test 1, ensures clusters found)
                input[2] = 3           // min_samples (slightly different from test 1)
                input[3] = 0.5         // cluster_selection_epsilon (test merging)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.clusters.size() == 1 },
                { assert process.out.cluster_info.size() == 1 },
                { assert process.out.plot.size() == 1 },
                { assert process.out.versions.size() == 1 },
                { assert process.out.clusters[0][1].toString().endsWith('.clusters.tsv') },
                { assert process.out.cluster_info[0][1].toString().endsWith('.cluster_info.json') },
                { assert process.out.plot[0][1].toString().endsWith('.clusters_plot.png') }
            )
        }

    }

    test("Should run with relaxed clustering parameters") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_relaxed', single_end:true ],
                    file(params.test_data.nanopore.analysis.umap_coords, checkIfExists: true)
                ]
                input[1] = 2           // very small clusters allowed
                input[2] = 2           // fewer samples required
                input[3] = 0.5         // larger epsilon for merging
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.clusters.size() == 1 },
                { assert process.out.cluster_info.size() == 1 }
            )
        }

    }

    test("Should run stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id:'test_stub', single_end:true ],
                    file(params.test_data.nanopore.analysis.umap_coords, checkIfExists: true)
                ]
                input[1] = 10          // min_cluster_size (consistent with other tests)
                input[2] = 5           // min_samples
                input[3] = 0.0         // cluster_selection_epsilon
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.clusters.size() == 1 },
                { assert process.out.cluster_info.size() == 1 },
                { assert process.out.plot.size() == 1 },
                { assert process.out.clusters[0][1].toString().endsWith('.clusters.tsv') },
                { assert process.out.cluster_info[0][1].toString().endsWith('.cluster_info.json') }
            )
        }

    }

}
