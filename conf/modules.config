/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

process {

    // Default publishing directory for all processes
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode ?: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    // QC modules
    withName: 'FASTQC' {
        ext.args = '--quiet'
        publishDir = [
            path: { "${params.outdir}/fastqc" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{html,zip}'
        ]
    }

    withName: 'NANOPLOT' {
        publishDir = [
            path: { "${params.outdir}/nanoplot" },
            mode: params.publish_dir_mode ?: 'copy'
        ]
    }

    withName: 'MULTIQC' {
        ext.args = params.multiqc_title ? "--title \"${params.multiqc_title}\"" : ''
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode ?: 'copy'
        ]
    }

    // Clustering modules
    withName: 'SEQTK_SAMPLE' {
        ext.seed = 42  // Deterministic sampling for reproducibility
        publishDir = [
            path: { "${params.outdir}/${meta.id}/subsampled_reads" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.sampled.fastq',
            enabled: false  // Don't publish by default to save space
        ]
    }

    withName: 'KMERFREQ' {
        ext.args = params.kmer_output_format ? "--output-format ${params.kmer_output_format}" : ''
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kmer_freq" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{txt.gz,npz}',
            enabled: false  // Disable - large intermediate file, only used for dimensionality reduction
        ]
    }

    // Phase 2 Memory Optimizations
    withName: 'PCA' {
        ext.args = ''
        ext.random_state = 42
        ext.min_variance = params.pca_min_variance ?: 0.99
        // Memory override for low-memory systems (PCA works on sparse matrices)
        memory = { check_max( 8.GB * task.attempt, 'memory' ) }
        publishDir = [
            path: { "${params.outdir}/${meta.id}/pca" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{tsv,json}'
        ]
    }

    withName: 'UMAP' {
        ext.args = params.umap_low_memory ? '--low-memory' : ''
        publishDir = [
            path: { "${params.outdir}/${meta.id}/umap" },
            mode: params.publish_dir_mode ?: 'copy'
        ]
    }

    withName: 'PACMAP' {
        ext.args = ''
        ext.random_state = 42
        ext.mn_ratio = params.pacmap_mn_ratio ?: 0.5
        ext.fp_ratio = params.pacmap_fp_ratio ?: 2.0
        // Memory override for low-memory systems (PaCMAP is memory-efficient)
        memory = { check_max( 14.GB * task.attempt, 'memory' ) }
        publishDir = [
            path: { "${params.outdir}/${meta.id}/pacmap" },
            mode: params.publish_dir_mode ?: 'copy'
        ]
    }

    withName: 'HDBSCAN' {
        ext.args = "--min-cluster-size ${params.min_cluster_size} --cluster-selection-epsilon ${params.cluster_sel_epsilon}"
        publishDir = [
            path: { "${params.outdir}/${meta.id}/clustering" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{tsv,png,json}'
        ]
    }

    withName: 'SPLITCLUSTERS' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/split_clusters" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: 'cluster_*.fastq',
            enabled: false  // Disable - intermediate files, only used for assembly
        ]
    }

    // Assembly & polishing modules
    withName: 'RAVEN_CORRECT' {
        ext.polishing_rounds = 2  // Raven built-in polishing rounds
        publishDir = [
            path: { "${params.outdir}/${meta.id}/raven_correct" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.correctedReads.fasta',
            enabled: false  // Disable - intermediate files, only used for draft selection
        ]
    }

    withName: 'DRAFT_SELECTION' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/draft_selection" },
            mode: params.publish_dir_mode ?: 'copy',
            enabled: false  // Disable - intermediate files, only used for Racon polishing
        ]
    }

    withName: 'RACON_ITERATIVE' {
        ext.args = "-m 8 -x -6 -g -8 -w 500"
        ext.racon_rounds = 4
        publishDir = [
            path: { "${params.outdir}/${meta.id}/racon" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*_polished.fasta'
        ]
    }

    withName: 'MEDAKA' {
        ext.args = '-m r941_min_high_g360'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/medaka" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*_consensus.fasta'
        ]
    }

    // Classification modules
    withName: 'CLASSIFY_CONSENSUS' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/classification" },
            mode: params.publish_dir_mode ?: 'copy'
        ]
    }

    // Results aggregation
    withName: 'JOINCONSENSUS' {
        publishDir = [
            path: { "${params.outdir}/consensus" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: 'all_consensus.fasta'
        ]
    }

    withName: 'GETABUNDANCES' {
        publishDir = [
            path: { "${params.outdir}/abundances" },
            mode: params.publish_dir_mode ?: 'copy'
        ]
    }

    withName: 'PLOTRESULTS' {
        publishDir = [
            path: { "${params.outdir}/plots" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{png,html}'
        ]
    }

    withName: 'AGGREGATE_CLASSIFICATIONS' {
        publishDir = [
            enabled: false  // Intermediate file - only used for EXTRACT_NOVEL_SEQUENCES
        ]
    }

    withName: 'EXTRACT_NOVEL_SEQUENCES' {
        publishDir = [
            path: { "${params.outdir}/novel_sequences" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{fasta,tsv}'
        ]
    }

    withName: 'BUILD_PHYLOTREE' {
        publishDir = [
            path: { "${params.outdir}/phylogeny" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{tree,aln.fasta,tree_stats.txt}'
        ]
    }

    withName: 'CREATE_PHYLOSEQ' {
        publishDir = [
            path: { "${params.outdir}/phyloseq" },
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*.{rds,txt}'
        ]
    }
}
