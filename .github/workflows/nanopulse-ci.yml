name: NanoPulse CI/CD

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master, dev]
  workflow_dispatch:

# Cancel previous runs if a new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Job 1: Pre-flight checks (fast validation)
  # ===========================================================================
  preflight:
    name: Pre-flight checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: "25.10.0"

      - name: Check Nextflow version
        run: |
          nextflow -version
          echo "Nextflow installation successful"

      - name: Validate Nextflow configuration
        run: |
          nextflow config -show-profiles

      - name: Check for syntax errors
        run: |
          nextflow run . -profile test,docker --help

  # ===========================================================================
  # Job 2: Unit tests (nf-test with Docker)
  # ===========================================================================
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: preflight
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: "25.10.0"

      - name: Setup nf-test
        uses: nf-core/setup-nf-test@v1

      - name: Setup Docker
        run: |
          docker --version

      - name: Run nf-test unit tests
        run: |
          nf-test test \
            --profile docker,test \
            --verbose

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-report
          path: |
            .nf-test/tests/**/*.log

  # ===========================================================================
  # Job 3: Integration tests (stub - fast CI validation)
  # ===========================================================================
  integration-tests-stub:
    name: Integration (stub)
    runs-on: ubuntu-latest
    needs: preflight
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: "25.10.0"

      - name: Setup nf-test
        uses: nf-core/setup-nf-test@v1

      - name: Generate synthetic test data
        run: |
          python tests/scripts/generate_synthetic_fastq.py \
            --output tests/testdata/integration/small_100reads.fastq \
            --reads 100 \
            --clusters 3 \
            --seed 42

      - name: Run stub integration tests
        run: |
          nf-test test tests/workflows/nanopulse.nf.test \
            --profile docker,test \
            --verbose \
            -stub

  # ===========================================================================
  # Job 4: Integration tests (small dataset - 100 reads)
  # ===========================================================================
  integration-tests-small:
    name: Integration (100 reads)
    runs-on: ubuntu-latest
    needs: [unit-tests]
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: "25.10.0"

      - name: Setup nf-test
        uses: nf-core/setup-nf-test@v1

      - name: Generate synthetic test data
        run: |
          mkdir -p tests/testdata/integration
          python tests/scripts/generate_synthetic_fastq.py \
            --output tests/testdata/integration/small_100reads.fastq \
            --reads 100 \
            --clusters 3 \
            --seed 42
          python tests/scripts/generate_synthetic_fastq.py \
            --output tests/testdata/integration/medium_500reads.fastq \
            --reads 500 \
            --clusters 5 \
            --seed 42
          python tests/scripts/generate_synthetic_fastq.py \
            --output tests/testdata/integration/single_cluster_200reads.fastq \
            --reads 200 \
            --clusters 1 \
            --seed 42

      - name: Run integration tests
        run: |
          nf-test test tests/workflows/nanopulse.nf.test \
            --profile docker,test \
            --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .nf-test/tests/**/*.log
            .nf-test/tests/**/*.snap

  # ===========================================================================
  # Job 5: Lint pipeline (nf-core standards)
  # ===========================================================================
  lint:
    name: nf-core lint
    runs-on: ubuntu-latest
    needs: preflight

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install nf-core tools
        run: |
          pip install nf-core

      - name: Run nf-core lint
        run: |
          nf-core pipelines lint
        continue-on-error: true

  # ===========================================================================
  # Job 6: Test with real data (only on master or manual trigger)
  # ===========================================================================
  integration-tests-real:
    name: Integration (real data)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    needs: [integration-tests-small]
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: "25.10.0"

      - name: Run pipeline with real test data
        run: |
          nextflow run . \
            -profile test,docker \
            --input test_datasets/samplesheet_mock4.csv \
            --outdir test_results \
            --enable_blast false \
            --enable_kraken2 false

      - name: Validate outputs
        run: |
          test -f test_results/joinconsensus/mock4_run3_consensus.fasta
          test -f test_results/getabundances/mock4_run3_abundances.csv
          test -f test_results/plotresults/mock4_run3_plots.html

      - name: Upload real data results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-real-results
          path: |
            test_results/joinconsensus/*
            test_results/getabundances/*
            test_results/plotresults/*
            test_results/pipeline_info/*

  # ===========================================================================
  # Job 7: Summary and reporting
  # ===========================================================================
  report:
    name: Test summary
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, unit-tests, integration-tests-stub, integration-tests-small]

    steps:
      - name: Generate test summary
        run: |
          echo "# NanoPulse CI Test Summary" > summary.md
          echo "" >> summary.md
          echo "**Commit:** ${{ github.sha }}" >> summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> summary.md
          echo "**Triggered by:** ${{ github.event_name }}" >> summary.md
          echo "" >> summary.md
          echo "## Test Results" >> summary.md
          echo "- Lint: ${{ needs.lint.result }}" >> summary.md
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> summary.md
          echo "- Integration (stub): ${{ needs.integration-tests-stub.result }}" >> summary.md
          echo "- Integration (small): ${{ needs.integration-tests-small.result }}" >> summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: summary.md
